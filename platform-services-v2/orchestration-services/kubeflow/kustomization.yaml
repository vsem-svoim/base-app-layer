apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: kubeflow-pipelines
  namespace: kubeflow

resources:
  - namespace.yaml
  - kubeflow-rbac.yaml
  - kubeflow-mysql.yaml
  - kubeflow-pipelines-deployment.yaml
  - kubeflow-ui-deployment.yaml
  - kubeflow-services.yaml
  # Ingress excluded - using centralized Platform UI ALB proxy instead
  # - kubeflow-ingress.yaml

namespace: kubeflow

labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/name: kubeflow-pipelines
    app.kubernetes.io/component: ml-workflows
    app.kubernetes.io/part-of: base-platform
    deployment.wave: "2"

patches:
- target:
    kind: Deployment
    name: kubeflow-mysql
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_memory
- target:
    kind: Deployment
    name: kubeflow-pipelines-api-server
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_compute
- target:
    kind: Deployment
    name: kubeflow-ui-server
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_general