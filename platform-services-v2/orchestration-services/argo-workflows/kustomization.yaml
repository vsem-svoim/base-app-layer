apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: argo-workflows
  annotations:
    argocd.argoproj.io/sync-wave: "2"

resources:
- argo-workflows-installation.yaml
- workflow-templates.yaml

namespace: argo-workflows

labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/name: argo-workflows
    app.kubernetes.io/component: workflow-engine
    app.kubernetes.io/part-of: base-platform
    deployment.wave: "2"

patches:
- target:
    kind: Deployment
    name: argo-server
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_system
- target:
    kind: Deployment
    name: workflow-controller
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_system
- target:
    kind: StatefulSet
    name: workflow-postgres
  patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        eks.amazonaws.com/nodegroup: platform_system