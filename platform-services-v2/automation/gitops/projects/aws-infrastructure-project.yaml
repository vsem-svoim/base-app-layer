apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: aws-infrastructure
  namespace: argocd
spec:
  description: "AWS Infrastructure components and Crossplane resources"
  sourceRepos:
  - 'https://github.com/vsem-svoim/base-app-layer.git'
  - 'https://github.com/vsem-svoim/base-app-layer.git'
  - 'https://charts.crossplane.io/stable'
  - 'https://kubernetes-sigs.github.io/aws-load-balancer-controller'
  - 'https://istio-release.storage.googleapis.com/charts'

  destinations:
  - namespace: 'crossplane-system'
    server: https://kubernetes.default.svc
  - namespace: 'istio-system'
    server: https://kubernetes.default.svc
  - namespace: 'istio-*'
    server: https://kubernetes.default.svc
  - namespace: 'kube-system'
    server: https://kubernetes.default.svc
  - namespace: 'aws-*'
    server: https://kubernetes.default.svc

  clusterResourceWhitelist:
  - group: '*'
    kind: '*'

  namespaceResourceWhitelist:
  - group: '*'
    kind: '*'

  roles:
  - name: infrastructure-admin
    description: "AWS Infrastructure administrators"
    policies:
    - p, proj:aws-infrastructure:infrastructure-admin, applications, *, aws-infrastructure/*, allow
    - p, proj:aws-infrastructure:infrastructure-admin, repositories, *, *, allow
    groups:
    - platform-engineering
    - infrastructure-team

  - name: infrastructure-viewer
    description: "AWS Infrastructure viewers"
    policies:
    - p, proj:aws-infrastructure:infrastructure-viewer, applications, get, aws-infrastructure/*, allow
    - p, proj:aws-infrastructure:infrastructure-viewer, repositories, get, *, allow
    groups:
    - developers
    - sre-team