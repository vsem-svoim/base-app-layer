apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: platform-applications
  namespace: argocd
spec:
  description: "Application layer services (Wave 3) - Platform UI, API Gateway, Data Services"
  
  sourceRepos:
  - 'https://github.com/vsem-svoim/base-app-layer.git'
  - 'https://charts.jetstack.io'
  - 'https://kubernetes.github.io/ingress-nginx'
  - 'https://charts.bitnami.com/bitnami'

  destinations:
  - namespace: 'platform-ui'
    server: https://kubernetes.default.svc
  - namespace: 'api-gateway'
    server: https://kubernetes.default.svc
  - namespace: 'data-services'
    server: https://kubernetes.default.svc
  - namespace: 'base-*'
    server: https://kubernetes.default.svc
  - namespace: 'istio-system'
    server: https://kubernetes.default.svc

  clusterResourceWhitelist:
  - group: '*'
    kind: '*'

  namespaceResourceWhitelist:
  - group: '*'
    kind: '*'

  roles:
  - name: platform-applications-admin
    description: "Application layer services administrators"
    policies:
    - p, proj:platform-applications:platform-applications-admin, applications, *, platform-applications/*, allow
    - p, proj:platform-applications:platform-applications-admin, clusters, get, *, allow
    groups:
    - platform-engineering
    - application-team

  - name: platform-applications-user
    description: "Application layer services users"
    policies:
    - p, proj:platform-applications:platform-applications-user, applications, get, platform-applications/*, allow
    - p, proj:platform-applications:platform-applications-user, applications, sync, platform-applications/platform-ui-app, allow
    groups:
    - business-users
    - data-analysts

  orphanedResources:
    warn: true
    ignore:
    - group: v1
      kind: Secret
      name: "*-token-*"
    - group: networking.istio.io
      kind: Gateway
      name: "*"