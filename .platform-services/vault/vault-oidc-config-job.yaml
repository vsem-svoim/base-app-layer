---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-oidc-config
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app: vault-oidc-config
    spec:
      serviceAccountName: vault-bootstrap
      restartPolicy: Never
      containers:
      - name: vault-oidc-config
        image: hashicorp/vault:1.20.1
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "ğŸ”§ Configuring Vault OIDC for Platform Dashboard..."
          
          # Install prerequisites
          apk add --no-cache curl jq openssl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && mv kubectl /usr/local/bin/
          
          # Connect to Vault
          VAULT_POD_IP=$(kubectl get pod vault-0 -n vault -o jsonpath='{.status.podIP}')
          export VAULT_ADDR="http://$VAULT_POD_IP:8200"
          
          # Login with root token
          ROOT_TOKEN=$(kubectl get secret vault-unseal-keys -n vault -o jsonpath='{.data.root-token}' | base64 -d)
          vault login "$ROOT_TOKEN"
          
          echo "ğŸ†” Setting up OIDC Application for Platform Dashboard..."
          
          # Enable OIDC auth method
          vault auth enable -path=oidc oidc || true
          
          # Configure OIDC as identity provider (self-hosted)
          vault write identity/oidc/config \
            issuer="https://vault.base-app-layer.dev"
          
          # Create OIDC key first
          vault write identity/oidc/key/platform-dashboard-key \
            algorithm="RS256"
          
          # Create assignment for platform users
          vault write identity/oidc/assignment/platform-users \
            group_ids="" \
            entity_ids=""
          
          # Get Platform UI Load Balancer DNS dynamically
          echo "ğŸŒ Discovering Platform UI Load Balancer..."
          PLATFORM_LB_DNS=$(kubectl get ingress platform-ui-ingress -n platform-ui -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -z "$PLATFORM_LB_DNS" ]; then
            PLATFORM_LB_DNS=$(kubectl get ingress platform-ui-ingress -n platform-ui -o jsonpath='{.spec.rules[0].host}' 2>/dev/null || echo "platform.base-app-layer.dev")
          fi
          
          echo "ğŸ“ Platform UI Load Balancer: $PLATFORM_LB_DNS"
          
          # Create OIDC application for platform dashboard with dynamic URLs
          vault write identity/oidc/client/platform-dashboard \
            redirect_uris="http://${PLATFORM_LB_DNS}/auth/callback,https://${PLATFORM_LB_DNS}/auth/callback,https://argocd.base-app-layer.dev/auth/callback" \
            assignments="platform-users" \
            key="platform-dashboard-key" \
            id_token_ttl="30m" \
            access_token_ttl="1h"
          
          # Create OIDC key for signing tokens
          vault write identity/oidc/key/platform-dashboard-key \
            algorithm="RS256" \
            allowed_client_ids="platform-dashboard"
          
          # Create user entities and groups
          echo "ğŸ‘¥ Creating Users and Groups..."
          
          # Create admin user
          vault write identity/entity name="admin" \
            policies="admin" \
            metadata="role=admin"
          
          # Create developer user  
          vault write identity/entity name="developer" \
            policies="platform-services,base-layer" \
            metadata="role=developer"
          
          # Create data scientist user
          vault write identity/entity name="data-scientist" \
            policies="ml-platform,base-layer" \
            metadata="role=data-scientist"
          
          # Create groups
          vault write identity/group name="platform-admins" \
            policies="admin" \
            metadata="description=Platform administrators"
          
          vault write identity/group name="platform-developers" \
            policies="platform-services,base-layer" \
            metadata="description=Platform developers"
          
          vault write identity/group name="data-scientists" \
            policies="ml-platform,base-layer" \
            metadata="description=Data scientists and ML engineers"
          
          # Create userpass auth for simple login
          vault auth enable userpass || true
          
          # Create users with passwords
          ADMIN_PASS=$(openssl rand -base64 16)
          DEV_PASS=$(openssl rand -base64 16)
          DS_PASS=$(openssl rand -base64 16)
          
          vault write auth/userpass/users/admin \
            password="$ADMIN_PASS" \
            policies="admin"
          
          vault write auth/userpass/users/developer \
            password="$DEV_PASS" \
            policies="platform-services,base-layer"
          
          vault write auth/userpass/users/data-scientist \
            password="$DS_PASS" \
            policies="ml-platform,base-layer"
          
          echo "ğŸ” Storing User Credentials..."
          
          # Store user credentials securely
          vault kv put secret/platform/users \
            admin-username="admin" \
            admin-password="$ADMIN_PASS" \
            developer-username="developer" \
            developer-password="$DEV_PASS" \
            data-scientist-username="data-scientist" \
            data-scientist-password="$DS_PASS"
          
          echo ""
          echo "ğŸ”‘ GENERATED USER PASSWORDS - SAVE THESE!"
          echo "========================================="
          echo "ğŸ‘¤ Admin User:"
          echo "   Username: admin"
          echo "   Password: $ADMIN_PASS"
          echo ""
          echo "ğŸ‘¨â€ğŸ’» Developer User:"
          echo "   Username: developer"
          echo "   Password: $DEV_PASS"
          echo ""
          echo "ğŸ‘©â€ğŸ”¬ Data Scientist User:"
          echo "   Username: data-scientist"
          echo "   Password: $DS_PASS"
          echo "========================================="
          
          # Get OIDC application details
          CLIENT_ID=$(vault read -field=client_id identity/oidc/client/platform-dashboard)
          CLIENT_SECRET=$(vault read -field=client_secret identity/oidc/client/platform-dashboard)
          
          # Append user credentials to the vault credentials file
          echo "ğŸ“ Adding user credentials to vault credentials file..."
          cat >> /vault/data/vault-credentials.txt << EOF

## User Credentials (Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ))
# ==========================================

## Admin User
ADMIN_USERNAME=admin
ADMIN_PASSWORD=$ADMIN_PASS

## Developer User
DEVELOPER_USERNAME=developer
DEVELOPER_PASSWORD=$DEV_PASS

## Data Scientist User
DATA_SCIENTIST_USERNAME=data-scientist
DATA_SCIENTIST_PASSWORD=$DS_PASS

## Platform URLs
PLATFORM_UI_URL=http://${PLATFORM_LB_DNS}
VAULT_UI_URL=https://vault.base-app-layer.dev
ARGOCD_UI_URL=https://argocd.base-app-layer.dev

## OIDC Configuration
OIDC_CLIENT_ID=$CLIENT_ID
OIDC_ISSUER=https://vault.base-app-layer.dev

EOF
          
          # Store OIDC configuration for platform UI with dynamic URLs
          vault kv put secret/platform/oidc \
            issuer="https://vault.base-app-layer.dev" \
            client-id="$CLIENT_ID" \
            client-secret="$CLIENT_SECRET" \
            discovery-url="https://vault.base-app-layer.dev/v1/identity/oidc/.well-known/openid_configuration" \
            redirect-uri="http://${PLATFORM_LB_DNS}/auth/callback" \
            platform-url="http://${PLATFORM_LB_DNS}"
          
          echo "âœ… OIDC Configuration Completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” VAULT OIDC AUTHENTICATION READY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ OIDC Issuer: https://vault.base-app-layer.dev"
          echo "ğŸ¯ Client ID: $CLIENT_ID"
          echo "ğŸ‘¤ Users: admin, developer, data-scientist"
          echo "ğŸ”‘ Auth Methods: userpass, oidc, kubernetes"
          echo "ğŸ—ï¸ Redirect URIs: platform-ui, argocd"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Platform Login URLs:"
          echo "â€¢ Vault UI: https://vault.base-app-layer.dev"
          echo "â€¢ Platform Dashboard: http://${PLATFORM_LB_DNS}"
          echo "â€¢ ArgoCD: https://argocd.base-app-layer.dev"
          echo ""
          echo "ğŸ‘¤ Test Login Credentials stored in: secret/platform/users"
          echo "ğŸ“ Complete credentials file: /vault/data/vault-credentials.txt"
          echo ""
          echo "ğŸ“‹ To access credentials file from outside cluster:"
          echo "   kubectl exec -n vault vault-0 -- cat /vault/data/vault-credentials.txt"
          
        env:
        - name: VAULT_SKIP_VERIFY
          value: "true"
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"