apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: automated-platform-deployment
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  labels:
    automation: "true"
    deployment-type: "automated"
spec:
  generators:
    # Wave 1: Infrastructure
    - list:
        elements:
          - name: crossplane-core-aws
            path: platform-services/argocd/applications/infrastructure/crossplane-core-aws.yaml
            project: orchestration-apps
            namespace: crossplane-system
            wave: "1"
            priority: "critical"
          - name: crossplane-aws-providers
            path: platform-services/argocd/applications/infrastructure/crossplane-aws-providers.yaml
            project: orchestration-apps
            namespace: crossplane-system
            wave: "1"
            priority: "critical"
    
    # Wave 2: Platform Services
    - list:
        elements:
          - name: monitoring-stack
            path: platform-services/argocd/applications/platform-services/monitoring-stack-app.yaml
            project: monitoring-apps
            namespace: monitoring
            wave: "2"
            priority: "high"
          - name: airflow
            path: platform-services/argocd/applications/platform-services/airflow-app.yaml
            project: workflow-apps
            namespace: airflow
            wave: "2"
            priority: "high"
    
    # Wave 3: Data Ingestion Layer
    - list:
        elements:
          - name: data-ingestion-agents
            path: platform-services/argocd/applications/base-layer/data-ingestion-app.yaml
            project: base-layer
            namespace: base-data-ingestion
            wave: "3"
            priority: "high"
            component: "agents"
    
    # Wave 4: ML Platform
    - list:
        elements:
          - name: mlflow
            path: platform-services/argocd/applications/ml-platform/mlflow-app.yaml
            project: ml-apps
            namespace: mlflow
            wave: "4"
            priority: "medium"
          - name: seldon-core
            path: platform-services/argocd/applications/ml-platform/seldon-core-app.yaml
            project: ml-apps
            namespace: seldon-system
            wave: "4"
            priority: "medium"
          - name: kubeflow
            path: platform-services/argocd/applications/ml-platform/kubeflow-app.yaml
            project: ml-apps
            namespace: kubeflow
            wave: "4"
            priority: "low"
  
  template:
    metadata:
      name: '{{name}}-automated'
      labels:
        app.kubernetes.io/name: '{{name}}'
        app.kubernetes.io/managed-by: 'applicationset'
        deployment-wave: '{{wave}}'
        deployment-priority: '{{priority}}'
        project: '{{project}}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{wave}}'
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: "platform-deployments"
    spec:
      project: '{{project}}'
      source:
        repoURL: https://github.com/vsem-svoim/base-app-layer.git
        targetRevision: HEAD
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - ApplyOutOfSyncOnly=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
      
      # Health checks specific to each component type
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
            - /spec/template/spec/containers/0/image
        - group: ""
          kind: ConfigMap
          jsonPointers:
            - /data
---
# Data Ingestion Components ApplicationSet
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: data-ingestion-components
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  labels:
    automation: "true"
    component: "data-ingestion"
spec:
  generators:
    - list:
        elements:
          - component: agents
            path: data_ingestion/agents
            kustomize: true
          - component: configs
            path: data_ingestion/configs
            kustomize: true
          - component: workflows
            path: data_ingestion/workflows
            kustomize: true
          - component: orchestrators
            path: data_ingestion/orchestrators
            kustomize: true
          - component: models
            path: data_ingestion/models
            kustomize: true
  
  template:
    metadata:
      name: 'data-ingestion-{{component}}'
      labels:
        app.kubernetes.io/name: 'data-ingestion'
        app.kubernetes.io/component: '{{component}}'
        app.kubernetes.io/part-of: 'base-ingestion-apps'
      annotations:
        argocd.argoproj.io/sync-wave: "3"
    spec:
      project: base-layer
      source:
        repoURL: https://github.com/vsem-svoim/base-app-layer.git
        targetRevision: HEAD
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: base-data-ingestion
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
        retry:
          limit: 3
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 2m