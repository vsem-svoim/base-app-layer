---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: base-layer-applications
  namespace: argocd
  labels:
    app.kubernetes.io/name: base-layer-applicationset
    app.kubernetes.io/component: applicationset-controller
spec:
  generators:
  - list:
      elements:
      - module: data_ingestion
        name: data-ingestion
        namespace: base-data-ingestion
        wave: "1"
        cluster: base
        description: "Multi-protocol data acquisition with 100GB/hour throughput"
        
  template:
    metadata:
      name: '{{name}}'
      namespace: argocd
      labels:
        app.kubernetes.io/name: '{{module}}'
        app.kubernetes.io/component: base-layer
        deployment.wave: '{{wave}}'
        target.cluster: '{{cluster}}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{wave}}'
        argocd.argoproj.io/compare-options: ServerSideDiff=true
      finalizers:
        - resources-finalizer.argocd.argoproj.io
        
    spec:
      project: base-layer
      
      source:
        repoURL: https://github.com/vsem-svoim/base-app-layer.git
        path: '{{module}}'
        targetRevision: main
        
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - PruneLast=true
          - ApplyOutOfSyncOnly=true
          - RespectIgnoreDifferences=true
          - ServerSideApply=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
            
      revisionHistoryLimit: 3
      
      ignoreDifferences:
      - group: apps
        kind: Deployment
        jsonPointers:
        - /spec/replicas
      - group: ""
        kind: Service
        jsonPointers:
        - /spec/clusterIP
      - group: networking.k8s.io
        kind: Ingress
        jsonPointers:
        - /status/loadBalancer/ingress
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: base-layer
  namespace: argocd
  labels:
    app.kubernetes.io/name: base-layer-project
spec:
  description: BASE App Layer - Enterprise Data Platform
  
  sourceRepos:
  - 'https://github.com/vsem-svoim/base-app-layer.git'
  - '*'
  
  destinations:
  - namespace: 'base-*'
    server: https://kubernetes.default.svc
  - namespace: 'kube-system'
    server: https://kubernetes.default.svc
    
  clusterResourceWhitelist:
  - group: ''
    kind: Namespace
  - group: rbac.authorization.k8s.io
    kind: ClusterRole
  - group: rbac.authorization.k8s.io
    kind: ClusterRoleBinding
  - group: apiextensions.k8s.io
    kind: CustomResourceDefinition
  - group: admissionregistration.k8s.io
    kind: MutatingWebhookConfiguration
  - group: admissionregistration.k8s.io
    kind: ValidatingWebhookConfiguration
    
  namespaceResourceWhitelist:
  - group: ''
    kind: '*'
  - group: apps
    kind: '*'
  - group: networking.k8s.io
    kind: '*'
  - group: extensions
    kind: '*'
  - group: batch
    kind: '*'
  - group: autoscaling
    kind: '*'
  - group: policy
    kind: '*'
  - group: monitoring.coreos.com
    kind: '*'
  - group: argoproj.io
    kind: '*'
    
  roles:
  - name: admin
    description: Admin access to BASE layer applications
    policies:
    - p, proj:base-layer:admin, applications, *, base-layer/*, allow
    - p, proj:base-layer:admin, clusters, get, *, allow
    - p, proj:base-layer:admin, repositories, *, *, allow
    groups:
    - base-layer:admin
    
  - name: developer
    description: Developer access to BASE layer applications
    policies:
    - p, proj:base-layer:developer, applications, get, base-layer/*, allow
    - p, proj:base-layer:developer, applications, sync, base-layer/*, allow
    - p, proj:base-layer:developer, applications, action/*, base-layer/*, allow
    - p, proj:base-layer:developer, logs, get, base-layer/*, allow
    groups:
    - base-layer:developer