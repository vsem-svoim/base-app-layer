apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: node-scaling-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: node-scaling
    rules:
    - alert: ExcessiveFargateNodes
      expr: |
        count(
          kube_node_info{
            node=~"fargate-.*"
          }
        ) > 20
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Excessive Fargate nodes detected"
        description: "More than 20 Fargate nodes are running. This may indicate runaway scaling."
        
    - alert: RapidNodeCreation
      expr: |
        increase(
          kube_node_created_time[5m]
        ) > 10
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "Rapid node creation detected"
        description: "More than 10 nodes were created in the last 5 minutes."
        
    - alert: PendingPodsRunaway
      expr: |
        count(
          kube_pod_status_phase{phase="Pending"}
        ) > 50
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Too many pending pods"
        description: "More than 50 pods are in Pending state for over 5 minutes. This may cause runaway scaling."

    - alert: DaemonSetPendingPods
      expr: |
        count(
          kube_pod_info{
            created_by_kind="DaemonSet",
            pod_status="Pending"
          }
        ) > 20
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "DaemonSet pods stuck in pending"
        description: "More than 20 DaemonSet pods are pending. This may indicate scheduling issues."