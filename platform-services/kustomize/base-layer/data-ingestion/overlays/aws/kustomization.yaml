apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Только AWS-специфичные ресурсы (базовые ресурсы развертываются через data-ingestion-app)
resources: []

# AWS-специфичные образы контейнеров
images:
  - name: base/data-collector:v2.5.0-fixed
    newName: python
    newTag: "3.12-slim"
  - name: base/data-connector:v2.5.0-fixed
    newName: python
    newTag: "3.12-slim"
  - name: base/data-converter:v2.5.0-fixed
    newName: python
    newTag: "3.13-slim"
  - name: base/data-fetch-retry:v2.5.0-fixed
    newName: python
    newTag: "3.12-slim"
  - name: base/data-merger:v2.5.0-analytics-fixed
    newName: python
    newTag: "3.13-slim"
  - name: base/data-scheduler:v2.5.0-analytics-fixed
    newName: python
    newTag: "3.12-slim"

# AWS-специфичные патчи для базовых развертываний
patches:
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUD_PROVIDER
          value: aws
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AWS_REGION
          value: us-east-1
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          kubernetes.io/os: linux
          node.kubernetes.io/instance-type: t3.medium

  - target:
      kind: PersistentVolumeClaim
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: gp3

  - target:
      kind: Service
      name: ".*-service"
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb

# AWS-специфичные метки
commonLabels:
  cloud.provider: aws
  cloud.region: us-east-1
  base.io/provider: aws

# AWS-специфичная конфигурация приложения
configMapGenerator:
  - name: data-ingestion-aws-config
    literals:
      - CLOUD_PROVIDER=aws
      - AWS_REGION=us-east-1
      - STORAGE_CLASS=gp3
      - LOAD_BALANCER_TYPE=nlb