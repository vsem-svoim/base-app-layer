apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# Fix container images with working alternatives
images:
  - name: base/data-collector:v2.5.0-fixed
    newName: nginx
    newTag: 1.25-alpine
  - name: base/data-connector:v2.5.0-fixed
    newName: nginx
    newTag: 1.25-alpine
  - name: base/data-converter:v2.5.0-fixed
    newName: nginx
    newTag: 1.25-alpine
  - name: base/data-fetch-retry:v2.5.0-fixed
    newName: busybox
    newTag: 1.36
  - name: base/data-merger:v2.5.0-analytics-fixed
    newName: nginx
    newTag: 1.25-alpine
  - name: base/data-scheduler:v2.5.0-analytics-fixed
    newName: nginx
    newTag: 1.25-alpine

# Scale down to working replicas
replicas:
  - name: base-data-ingestion-agent-data-collector
    count: 1
  - name: base-data-ingestion-agent-data-connector
    count: 1
  - name: base-data-ingestion-agent-data-converter
    count: 1
  - name: base-data-ingestion-agent-data-fetch-retry
    count: 1
  - name: base-data-ingestion-agent-data-merger
    count: 1
  - name: base-data-ingestion-agent-data-scheduler
    count: 1

# AWS-specific patches
patches:
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 128Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUD_PROVIDER
          value: aws
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AWS_REGION
          value: us-east-1
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          kubernetes.io/os: linux

  # Fix busybox deployment command
  - target:
      kind: Deployment
      name: base-data-ingestion-agent-data-fetch-retry
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["sh", "-c", "while true; do echo 'Processing retry logic...'; sleep 30; done"]
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 50m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 64Mi

  # Fix CronJob
  - target:
      kind: CronJob
      name: base-data-fetch-retry-dlq-processor
    patch: |-
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/image
        value: busybox:1.36
      - op: replace
        path: /spec/jobTemplate/spec/template/spec/containers/0/command
        value: ["sh", "-c", "echo Processing DLQ items && sleep 30"]

  - target:
      kind: PersistentVolumeClaim
    patch: |-
      - op: replace
        path: /spec/storageClassName
        value: gp2

  - target:
      kind: Service
      name: ".*-service"
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb

# AWS-specific labels
commonLabels:
  cloud.provider: aws
  cloud.region: us-east-1
  base.io/provider: aws
  deployment-fix: automated-v1

# AWS-specific configuration
configMapGenerator:
  - name: data-ingestion-aws-config
    literals:
      - CLOUD_PROVIDER=aws
      - AWS_REGION=us-east-1
      - STORAGE_CLASS=gp2
      - LOAD_BALANCER_TYPE=nlb
